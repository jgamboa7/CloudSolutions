name: "Terraform Apply"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to [staging]'
        required: true
        default: 'staging'
      plan_run_id:
        description: 'Run ID of the successful Plan workflow to deploy'
        required: true
      pr_number:
        description: 'The Pull Request number to post the Apply comment on'
        required: true
      tf_version:
        description: 'Terraform version to use'
        required: true
        default: '1.13.3'

concurrency:
  group: terraform-apply-${{ github.ref }}
  cancel-in-progress: false

jobs:
  apply:
    name: Terraform Apply
    permissions:  
          id-token: write
          contents: read
          actions: read
          pull-requests: write
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment}}
    outputs:
      cluster_name: ${{ steps.gen_output.outputs.cluster_name }}
      irsa_arn: ${{ steps.gen_output.outputs.irsa_arn }}
      vpc_id: ${{ steps.gen_output.outputs.vpc_id }}
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform CLI
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{github.event.inputs.tf_version}}

      - name: Cache Terraform plugins/providers
        uses: actions/cache@v4
        with:
          path: .terraform/
          key: ${{ runner.os }}-terraform-${{ hashFiles('.terraform.lock.hcl') }}
          
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
            role-to-assume: ${{secrets.ROLE_TO_ASSUME}}
            aws-region: ${{secrets.AWS_REGION}}

      - name: Terraform Init
        id: init
        run: |
          terraform init -input=false -no-color

      - name: "Download plan artifact"
        uses: actions/download-artifact@v4
        id: download_plan
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{github.repository}}
          run-id: ${{ github.event.inputs.plan_run_id }}
          name: terraform-plan
          path: tf-artifacts

      - name: "Terraform Show Plan"
        id: plan
        env:
          TF_VAR_eksAdmin: ${{secrets.EKS_IAM_ADMIN_USER_ARN}}
        continue-on-error: true
        run: |
          terraform show ./tf-artifacts/tfplan > plan.txt 2>&1 || true
          
          PL_EXIT=0
          if grep -qE "Error:" plan.txt; then
            PL_EXIT=1

          elif grep -qE "([1-9][0-9]*) to add|([1-9][0-9]*) to change|([1-9][0-9]*) to destroy" plan.txt; then
            PL_EXIT=2

          else
            PL_EXIT=0
          fi

          echo "plan_exit_code=${PL_EXIT}" >> $GITHUB_OUTPUT         
          PLAN_OUTPUT=$(cat plan.txt | tail -n 150)
          echo "plan_output<<EOF" >> $GITHUB_OUTPUT
          echo "$PLAN_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: No changes 
        if: steps.plan.outputs.plan_exit_code == 0
        uses: peter-evans/create-or-update-comment@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.inputs.pr_number }}
          body: |
            #### Terraform Plan üìñ - ${{ steps.plan.outcome }}
        
            <details><summary>########## Show Plan ##########</summary>

            ‚ÄúTerraform: No changes to apply (plan returned no changes).‚Äù
            
            #################################################################
            ${{ steps.plan.outputs.plan_output }}
            #################################################################
            
            </details>
            
            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Workflow: \`${{ github.workflow }}\`*`;
              
          edit-mode: replace
          comment-tag: terraform-plan-comment

      - name: Terraform Apply
        if: ${{ steps.plan.outputs.plan_exit_code == 2 }}
        id: apply
        env:
          TF_VAR_eksAdmin: ${{secrets.EKS_IAM_ADMIN_USER_ARN}}
        run: |
          terraform apply -input=false -no-color -auto-approve ./tf-artifacts/tfplan 2>&1 | tee apply.txt
          APPLY_OUTPUT=$(cat apply.txt | tail -n 150)

          echo "apply_output<<EOF" >> $GITHUB_OUTPUT
          echo "$APPLY_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload apply logs 
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-apply-logs
          path: apply.txt

      - name: Generate outputs
        if: ${{ steps.apply.outcome == 'success' }}
        id: gen_output
        run: |
          TF_OUTPUT_JSON=$(terraform output -json)

          CLUSTER_NAME=$(echo "$TF_OUTPUT_JSON" | jq -r '.cluster_name.value')
          IRSA_ARN=$(echo "$TF_OUTPUT_JSON" | jq -r '.irsa_arn.value')
          VPC_ID=$(echo "$TF_OUTPUT_JSON" | jq -r '.vpc_id.value')

          echo "cluster_name=$CLUSTER_NAME" >> "$GITHUB_OUTPUT"
          echo "irsa_arn=$IRSA_ARN" >> "$GITHUB_OUTPUT"
          echo "vpc_id=$VPC_ID" >> "$GITHUB_OUTPUT"

      - name: Add Apply Comment
        if: always()
        uses: peter-evans/create-or-update-comment@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.inputs.pr_number }}
          body: |
            # Deployment to ${{ github.event.inputs.environment }}

            #### Terraform Initialization ‚öôÔ∏è   - ${{ steps.init.outcome }}

            <details><summary>########## terraform apply logs Summary ##########</summary>

            ######################## terraform ########################
            ${{ steps.apply.outputs.apply_output}}
            ###########################################################

            </details>

            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Workflow: \`${{ github.workflow }}\`*`;
              
          edit-mode: replace
          comment-tag: terraform-apply-comment

      - name: Final status check
        if: always()
        run: |
          if [ "${{ steps.plan.outputs.plan_exit_code }}" = "2" ]; then
            if grep -q "Error:" apply.txt; then
              echo "Deployment failed! See apply.txt artifact for details."
              exit 1
            elif [ "${{ steps.apply.outcome }}" != "success" ]; then
              echo "Deployment failed! Apply step did not exit successfully."
              exit 1
            else
              echo "Apply succeeded."
            fi
          else
            echo "Apply skipped: No changes detected in plan (Exit Code 0 or 1)."
          fi
  helm-elb-installation:
    name: elb-installation
    permissions:  
          id-token: write
          contents: read
          actions: read
          pull-requests: write 
    needs: apply
    if: ${{ success()}}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment}}
    defaults:
      run:
        shell: bash
    env: 
      CLUSTER_NAME: ${{ needs.apply.outputs.cluster_name }}
      IRSA_ARN: ${{ needs.apply.outputs.irsa_arn }}
      VPC_ID: ${{  needs.apply.outputs.vpc_id }}      
      AWS_REGION: ${{ secrets.AWS_REGION}}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
            role-to-assume: ${{secrets.ROLE_TO_ASSUME}}
            aws-region: ${{secrets.AWS_REGION}}

      - name: Configure Kubectl
        run: |
          aws eks --region $AWS_REGION update-kubeconfig --name $CLUSTER_NAME

      - name: Install CRDs
        run: |
          kubectl apply -f ./aws-load-balancer-controller/crds/crds.yaml

      - name: Install load balancer controller
        id: controller-install  
        run: |
          helm upgrade --install aws-load-balancer-controller ./aws-load-balancer-controller \
          -f ./aws-load-balancer-controller/elbvalues.yaml \
          -n kube-system \
          --set clusterName=$CLUSTER_NAME \
          --set serviceAccount.annotations."eks\.amazonaws\.com/role-arn"=$IRSA_ARN \
          --set vpcId=$VPC_ID \
          --version 1.14.0 \
          | tee elb_logs.txt

          HELM_LOGS=$(cat elb_logs.txt)
          echo "helm_logs<<EOF" >> $GITHUB_OUTPUT
          echo "$HELM_LOGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload helm logs 
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: helm-logs
          path: elb_logs.txt

      - name: Add helm Comment
        if: always()
        uses: peter-evans/create-or-update-comment@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.inputs.pr_number }}
          body: |
            # Deployment to ${{ github.event.inputs.environment }}

            <details><summary>########## Helm Logs ##########</summary>

            ########################## HELM ##########################
            ${{ steps.controller-install.outputs.helm_logs}}
            ###########################################################

            </details>

            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Workflow: \`${{ github.workflow }}\`*`;
              
          edit-mode: replace
          comment-tag: terraform-apply-comment

  helm-elk-installation:
    name: elk-installation
    permissions:  
          id-token: write
          contents: read
          actions: read
          pull-requests: write 
    needs: helm-elb-installation
    if: ${{ success()}}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment}}
    defaults:
      run:
        shell: bash
    env: 
      CLUSTER_NAME: ${{ needs.apply.outputs.cluster_name }}     
      AWS_REGION: ${{ secrets.AWS_REGION}}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
            role-to-assume: ${{secrets.ROLE_TO_ASSUME}}
            aws-region: ${{secrets.AWS_REGION}}

      - name: Configure Kubectl
        run: |
          aws eks --region $AWS_REGION update-kubeconfig --name $CLUSTER_NAME

      - name: storageclass
        id: storage  
        run: kubectl apply -f ./k8s/storageclass/es-storageclass.yaml 

      - name: install Elasticsearch
        id: elasticsearch
        run: helm upgrade --install elk-elasticsearch ./elastic_stack/elasticsearch/ -n elastic-stack -f ./elastic_stack/elasticsearch/myvalues.yaml --create-namespace

      - name: install kibana 
        id: kibana
        if: ${{ success()}}  
        run: helm upgrade --install elk-kibana ./elastic_stack/kibana -n elastic-stack 

      - name: netpoli
        id: netpoli
        run: kubectl apply -f ./k8s/network-policies/fluentd-netpol.yaml 

      - name: fluentd-aggregator
        id: fluentd
        run:  helm upgrade --install fluentd ./elastic_stack/fluentd -n elastic-stack -f ./elastic_stack/fluentd/fluentvalues.yaml 

      - name: fluent-bit-forwarder
        id: fluent-bit
        run:  helm upgrade --install fluent-bit ./elastic_stack/fluent-bit -n elastic-stack -f ./elastic_stack/fluent-bit/bitvalues.yaml 

      - name: Add Comment
        if: always()
        uses: peter-evans/create-or-update-comment@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.inputs.pr_number }}
          body: |
            #### StorageClass   - ${{ steps.storage.outcome}}
            #### elasticsearch  - ${{ steps.elasticsearch.outcome }}
            #### Kibana         - ${{ steps.kibana.outcome}}
            #### Network Policy - ${{ steps.netpoli.outcome }}
            #### Fluentd        - ${{ steps.fluentd.outcome }}
            #### Fluent-bit     - ${{ steps.fluent-bit.outcome }}

              *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Workflow: \`${{ github.workflow }}\`*`;

          edit-mode: replace
          comment-tag: terraform-plan-comment

          