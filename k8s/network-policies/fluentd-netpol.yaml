apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-fluentbit-to-fluentd
  namespace: elastic-stack
spec:
  # 1. Select the target Fluentd Pods (where traffic is going)
  podSelector:
    matchLabels:
      app.kubernetes.io/name: fluentd 
      app.kubernetes.io/instance: fluentd 
  
  # This policy applies to incoming traffic (Ingress)
  policyTypes:
  - Ingress
  
  # Define the rules for incoming traffic
  ingress:
  - from:
    # 2. Define the authorized source Pods (Fluent Bit)
    # This selects all Fluent Bit DaemonSet pods in the namespace
    - podSelector:
        matchLabels:
          k8s-app: fluent-bit
          
    # 3. Define the allowed port
    ports:
    - protocol: TCP
      port: 24224 # Fluentd's forward input port